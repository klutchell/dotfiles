#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

usage()
{
	cat << EOF
usage: $(basename "$0") [--help] [dir1] [dir2]
example: sudo $(basename "$0") /data/plex/tv /data/plex/movies
EOF
	exit 0
}

expr "$*" : ".*--help" > /dev/null && usage

readonly LOG_FILE="/tmp/$(basename "$0").log"
info()    { echo "$(date) [INFO]    $*" ; }
warning() { echo "$(date) [WARNING] $*" ; }
error()   { echo "$(date) [ERROR]   $*" ; }
fatal()   { echo "$(date) [FATAL]   $*" ; exit 1 ; }
exec >  >(tee -ia "$LOG_FILE")
exec 2> >(tee -ia "$LOG_FILE" >&2)

cleanup() {
	info "cleaning up..."
	# Remove temporary files, etc...
	# Restart services, etc...
	info "finished"
}

# exit here if this script was sourced
[[ "${BASH_SOURCE[0]:-$0}" != "$0" ]] && exit 0

trap cleanup EXIT

[ -n "$1" ] || usage

info "cleaning $*..."

# update installed packages
sudo apt update
sudo apt -y upgrade
sudo apt -y autoremove

# install common utilities
info "installing some common utilities..."
curl https://raw.githubusercontent.com/klutchell/dotfiles/master/bin/bin/myinstall | sudo bash -s ntp git make stow \
|| warning "some utilities failed to install"

github_user="${1:-none}"

if [ "$github_user" == "none" ]; then
	warning "no github user provided, exiting..."
	exit 0
fi

# download public keys from github
info "downloading public ssh keys from github..."
curl "https://github.com/$github_user.keys" >> ~/.ssh/authorized_keys \
|| warning "downloading public keys failed"

# generate ssh key
if [ ! -f ~/.ssh/id_rsa.pub ]; then
	info "generating ssh-rsa key..."
	ssh-keygen -f ~/.ssh/id_rsa -N '' -t rsa -b 4096 \
	|| fatal "generating ssh-rsa key failed"
fi

# copy public key and title strings
key="$(cat ~/.ssh/id_rsa.pub)"
title="${key##* }"

# upload public ssh key to github
info "uploading public ssh-rsa key to github profile..." 
curl --user "$github_user" --data "{\"title\":\"${title}\",\"key\":\"${key}\"}" https://api.github.com/user/keys \
|| error "uploading public key failed"

# clone dotfiles
info "cloning dotfiles from repo..."
git clone git@github.com:klutchell/dotfiles.git ~/dotfiles \
|| fatal "cloning dotfiles repo failed"

# install dotfiles
info "installing dotfiles with stow..."
pushd ~/dotfiles
make install \
|| fatal "installing dotfiles failed"
popd
