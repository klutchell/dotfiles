#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

usage()
{
	cat << EOF
usage: $(basename "$0") [--help]
example: $0
EOF
	exit 0
}

expr "$*" : ".*--help" > /dev/null && usage

# edit these as needed
readonly scratchdir="$(mktemp -d -t tmp.XXXXXXXXXX)"
readonly logfile="/tmp/$(basename "$0").log"
# edit these as needed
readonly gdrive_configdir="/home/ubuntu/.gdrive"
readonly gdrive_cmd="/usr/local/bin/gdrive -c '${gdrive_configdir}'"
readonly gdrive_tmpfile="${scratchdir}/gdrive.tmp"
readonly gdrive_parentdir="0B8Hwaj3ywtn-Y1RmLWg3WmMtRFU"
# edit these as needed
readonly snapshotdir="/home/ubuntu/rsnapshot/alpha.0/localhost"
readonly max_to_keep=3

info()    { echo "[INFO]    $*" ; }
warning() { echo "[WARNING] $*" ; }
error()   { echo "[ERROR]   $*" ; }
fatal()   { echo "[FATAL]   $*" ; exit 1 ; }

exec >  >(ts | tee -ia "$logfile")
exec 2> >(ts | tee -ia "$logfile" >&2)

cleanup()
{
	info "cleaning up..."
	popd 2>/dev/null || true
	rm -rf "${scratchdir}" 2>/dev/null || true
	info "finished"
}

# exit here if this script was sourced
[[ "${BASH_SOURCE[0]:-}" != "$0" ]] && exit 0

trap cleanup EXIT

snapshot_list()
{
	# list snapshots on remote
	eval "$gdrive_cmd list --query \"name contains '$(hostname)' and '${gdrive_parentdir}' in parents and trashed = false\" --order \"createdTime desc\" > \"${gdrive_tmpfile}\""
	curr_snapshot_count="$(($(wc -l < "${gdrive_tmpfile}")-1))"
	info "counted $curr_snapshot_count snapshots on remote"
}

snapshot_upload()
{
	[ -d "$snapshotdir" ] || usage

	# tarball name includes hostname and timestamp of the snapshot dir
	tarball_name="$(hostname)_$(date -r "${snapshotdir}" +%Y.%m.%d_%H.%M.%S).tar.gz"

	# upload or update
	snapshot_list
	file_id="$(grep "${tarball_name}" "${gdrive_tmpfile}" | head -n1 | cut -d' ' -f1)" || true
	[ -n "$file_id" ] && fatal "$tarball_name already exists on remote!"

	# compress snapshot contents
	pushd "$snapshotdir" >/dev/null
	info "compressing $snapshotdir..."
	tar -czf "${scratchdir}/${tarball_name}" ./*
	popd >/dev/null

	info "uploading $tarball_name..."
	eval "$gdrive_cmd upload -p \"${gdrive_parentdir}\" \"${scratchdir}/${tarball_name}\""

	# delete oldest
	snapshot_list
	while [ "${curr_snapshot_count}" -gt "${max_to_keep}" ]; do
		file_id="$(tail -n1 ${gdrive_tmpfile} | cut -d' ' -f1)"
		info "deleting oldest file..."
		eval "$gdrive_cmd delete \"${file_id}\""
		snapshot_list
	done
}

snapshot_upload
