#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

usage()
{
	cat << EOF
usage: $(basename "$0") [--help] [utility-1] [utility-2]
example: $0 ntp git make stow
EOF
	exit 0
}

expr "$*" : ".*--help" > /dev/null && usage

readonly LOG_FILE="/tmp/$(basename "$0").log"
info()    { echo "$(date) [INFO]    $*" ; }
warning() { echo "$(date) [WARNING] $*" ; }
error()   { echo "$(date) [ERROR]   $*" ; }
fatal()   { echo "$(date) [FATAL]   $*" ; exit 1 ; }
exec >  >(tee -ia "$LOG_FILE")
exec 2> >(tee -ia "$LOG_FILE" >&2)

cleanup() {
	info "cleaning up..."
	# Remove temporary files, etc...
	# Restart services, etc...
	info "finished"
}

# exit here if this script was sourced
[[ "${BASH_SOURCE[0]:-$0}" != "$0" ]] && exit 0

trap cleanup EXIT

[ -n "${1:-}" ] || usage

info "installing $*..."

install_gdrive()
{
	# https://github.com/prasmussen/gdrive
	sudo bash -c "curl -L \"https://docs.google.com/uc?id=0B3X9GlR6EmbnQ0FtZmJJUXEyRTA&export=download\" > /usr/local/bin/gdrive"
	sudo chmod +x /usr/local/bin/gdrive
	gdrive version
}

install_speedtest()
{
	# https://github.com/sivel/speedtest-cli
	sudo apt-get install -y speedtest-cli
	speedtest --version || true
}

install_pip2()
{
	sudo apt-get install -y python
	curl https://bootstrap.pypa.io/get-pip.py | sudo -H python2
	pip2 --version
}

install_pip3()
{
	sudo apt-get install -y python3
	curl https://bootstrap.pypa.io/get-pip.py | sudo -H python3
	pip3 --version
}

install_docker()
{
	curl -sSL get.docker.com | sh
	sudo usermod -aG docker "$(who am i | awk '{print $1}')"
	docker --version
}

install_compose()
{
	install_pip2
	sudo -H pip2 install --upgrade docker-compose
	docker-compose --version
}

install_acdcli()
{
	install_pip3
	sudo -H pip3 install --upgrade git+https://github.com/yadayada/acd_cli.git
	acdcli version
}

install_whalebrew()
{
	# https://github.com/bfirsh/whalebrew
	latest_url="$(curl -s https://api.github.com/repos/bfirsh/whalebrew/releases | grep browser_download_url | grep "whalebrew-$(uname -s)-$(uname -m)" | head -n 1 | cut -d '"' -f 4)"
	sudo bash -c "curl -L \"$latest_url\" > /usr/local/bin/whalebrew"
	sudo chmod +x /usr/local/bin/whalebrew
	whalebrew version
}

install_lynis()
{
	# https://cisofy.com/documentation/lynis/get-started/
	sudo rm -rf /usr/local/lynis 2>/dev/null || true
	sudo git clone https://github.com/CISOfy/lynis /usr/local/lynis
	/usr/local/lynis/lynis --version
}

install_rclone()
{
	sudo apt-get install -y snap
	sudo snap install rclone --classic
	sudo snap refresh rclone
	rclone --version
}

install_git()
{
	sudo apt-get install -y software-properties-common
	sudo add-apt-repository ppa:git-core/ppa
	sudo apt-get-get update
	sudo apt-get install -y git
	git --version
}

install_subversion()
{
	sudo sh -c 'echo "deb http://opensource.wandisco.com/ubuntu `lsb_release -cs` svn19" >> /etc/apt/sources.list.d/subversion19.list'
	sudo wget -q http://opensource.wandisco.com/wandisco-debian.gpg -O- | sudo apt-key add -
	sudo apt-get update
	sudo apt-get install -y subversion
	svn --version
}

install_ntp()
{
	sudo timedatectl set-timezone 'America/New_York'
	sudo apt-get install -y ntp
	sudo ufw allow 'ntp' 2>/dev/null || true
}

install_ssh()
{
	sudo apt-get install -y openssh-server
	sudo ufw allow 'OpenSSH' 2>/dev/null || true
}

for util in "$@"
do
	if [ "$(type -t "install_${util}")" == "function" ]; then
		eval "install_${util}" || usage
	else
		sudo apt-get install -y "${util}" || usage
	fi
done
