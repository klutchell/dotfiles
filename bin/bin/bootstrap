#!/bin/bash

# update installed packages
sudo apt update
sudo apt -y upgrade
sudo apt -y autoremove

# install common utilities
curl https://raw.githubusercontent.com/klutchell/dotfiles/master/bin/bin/install | sudo bash -s ufw ssh ntp git nano moreutils

# download public ssh keys from github
curl https://github.com/klutchell.keys >> ~/.ssh/authorized_keys

# generate ssh key
ssh-keygen -f ~/.ssh/github_rsa -N '' -t rsa -b 4096

# add key to ssh-agent
eval $(ssh-agent -s)
ssh-add ~/.ssh/github_rsa

# copy public key and title strings
key="$(cat ~/.ssh/github_rsa.pub)"
title="${key##* }"

# upload publicy ssh key to github
curl --user "klutchell" --data "{\"title\":\"${title}\",\"key\":\"${key}\"}" https://api.github.com/user/keys

# install dotfiles
apt install -y make stow
git clone git@github.com:klutchell/dotfiles.git ~/dotfiles
pushd ~/dotfiles
make install
popd
