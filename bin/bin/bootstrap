#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

#/ Usage: bootstrap <github_user>
#/ Description: install common utilities and sync dotfiles with personal github repo
#/ Examples: bootstrap klutchell
#/ Options: github_user: github username for syncing ssh keys and cloning dotfiles
#/   --help: Display this help message

usage() { grep '^#/' "$0" | cut -c4- ; exit 0 ; }
expr "$*" : ".*--help" > /dev/null && usage

readonly LOG_FILE="/tmp/$(basename "$0").log"
info()    { echo "[INFO]    $*" | tee -a "$LOG_FILE" >&2 ; }
warning() { echo "[WARNING] $*" | tee -a "$LOG_FILE" >&2 ; }
error()   { echo "[ERROR]   $*" | tee -a "$LOG_FILE" >&2 ; }
fatal()   { echo "[FATAL]   $*" | tee -a "$LOG_FILE" >&2 ; exit 1 ; }

cleanup() {
    info "cleaning up..."
    # Remove temporary files
    # Restart services
    # ...
}

# exit here if this script was sourced
[[ "${BASH_SOURCE[0]:-$0}" != "$0" ]] && exit 0

trap cleanup EXIT

# update installed packages
sudo apt update
sudo apt -y upgrade

# install common utilities
info "installing some common utilities..."
(curl https://raw.githubusercontent.com/klutchell/dotfiles/master/bin/bin/myinstall | sudo bash -s git make stow \
|| warning "some utilities failed to install")

github_user="${1:-none}"

if [ "$github_user" == "none" ]; then
	warning "no github user provided, exiting..."
	exit 0
fi

# download public keys from github
info "downloading public ssh keys from github..."
mkdir ~/.ssh 2>/dev/null || true
curl "https://github.com/$github_user.keys" >> ~/.ssh/authorized_keys \
|| warning "downloading public keys failed"

# generate ssh key
if [ ! -f ~/.ssh/id_rsa.pub ]; then
	info "generating ssh-rsa key..."
	ssh-keygen -f ~/.ssh/id_rsa -N '' -t rsa -b 4096 \
	|| fatal "generating ssh-rsa key failed"
fi

# copy public key and title strings
key="$(cat ~/.ssh/id_rsa.pub)"
title="${key##* }"

# upload public ssh key to github
info "uploading public ssh-rsa key to github profile..." 
curl --user "$github_user" --data "{\"title\":\"${title}\",\"key\":\"${key}\"}" https://api.github.com/user/keys \
|| error "uploading public key failed"

# clone dotfiles
info "cloning dotfiles from repo..."
git clone git@github.com:klutchell/dotfiles.git ~/dotfiles \
|| fatal "cloning dotfiles repo failed"

# install dotfiles
info "installing dotfiles with stow..."
pushd ~/dotfiles
make install \
|| fatal "installing dotfiles failed"
popd
