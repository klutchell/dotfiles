#!/usr/bin/env bash

set -euo pipefail

# capture script exit
cleanup()
{
	local rc=$?
	info "exited with error level ${rc}"
	exit ${rc}
}

# get the command name without path
cmd()	{ basename "${0}" ; }

# determine absolute path to a provided file/folder
abs()	{ echo "$(cd "$(dirname "${1}")" && pwd)/$(basename "${1}")"; }

# append timestamp and loglevel prints
debug()		{ if [ "${debug_enabled:-}" == "true" ]; then 
			  echo "$(date)  [DEBUG]   $*" ; fi ; }
info()		{ echo "$(date)  [INFO]    $*" ; }
warning()	{ echo "$(date)  [WARNING] $*" ; }
error()		{ echo "$(date)  [ERROR]   $*" ; }
fatal()		{ echo "$(date)  [FATAL]   $*" ; exit 1 ; }

usage()
{
    cat <<EOF

Usage:
                $(cmd) <github_username> <github_keyname>
Description:
                Generate github rsa key and sync with github account for SSH authentication.
Examples:
                $(cmd) klutchell id_rsa.github
                $(cmd) --help
Parameters:
                github_username     github username for syncing SSH keys

                github_keyname      custom github keyname

                --help              display this help message

                --debug             enable debug logs

EOF
exit 2
}


# return here if this script was sourced
[[ "${BASH_SOURCE[0]:-${0}}" != "${0}" ]] && return

# trap any exit code beyond this point
trap cleanup INT TERM EXIT

# set defaults
debug_enabled="false"

# catch help param
expr "$*" : ".*--help" > /dev/null && usage

# catch debug param
expr "$*" : ".*--debug" > /dev/null && debug_enabled="true"

# read github username from params
github_username="${1:-}"

# read github keyname from params
github_keyname="${2:-}"


# WORK START


# prompt for github username if not provided
while [ -z "${github_username:-}" ]
do
	read -r -p "github username: " github_username < /dev/tty
done

# prompt for github username if not provided
while [ -z "${github_keyname:-}" ]
do
	read -r -e -p "github keyname: " -i "id_rsa.${github_username}@github.com" github_keyname < /dev/tty
done

readonly ssh_root="${HOME}/.ssh"
readonly github_privkey="${ssh_root}/${github_keyname}"
readonly github_pubkey="${ssh_root}/${github_keyname}.pub"
readonly pubkey_comment="${github_keyname/id_rsa\./} ($(id -un)@$(hostname))"

debug "ssh_root: '${ssh_root}'"
debug "github_privkey: '${github_privkey}'"
debug "github_pubkey: '${github_pubkey}'"
debug "pubkey_comment: '${pubkey_comment}'"

# if ssh folder does not exist, generate it and set permissions
if [ ! -d "${ssh_root}" ]
then
	mkdir "${ssh_root}" && chmod 700 "${ssh_root}"
fi

# check github ssh-rsa key exists
info "checking for existing public github ssh-rsa key..."
if [ -f "${github_pubkey}" ]
then
	# use existing github ssh-rsa key
	info "found '${github_pubkey}'"
else
	# generate github ssh-rsa key
	info "generating 4096-bit ssh-rsa key..."
	ssh-keygen -C "${pubkey_comment}" -f "${github_privkey}" -N '' -t "rsa" -b "4096" ||
		fatal "generating ssh-rsa key failed"
fi

# read public key
pubkey_data="$(<"${github_pubkey}")" || fatal "failed to read '${github_pubkey}'"

debug "pubkey_data: '${pubkey_data}'"

# download public keys from github
# info "downloading public ssh-rsa keys from github account..."
# curl "https://github.com/${github_username}.keys" >> "$(abs "${HOME}/.ssh/authorized_keys")" ||
# 	warning "downloading public keys failed"

# upload public ssh key to github
info "uploading public ssh-rsa key to github account..."
curl --user "${github_username}" --data "{\"title\":\"${pubkey_comment}\",\"key\":\"${pubkey_data}\"}" \
	https://api.github.com/user/keys < /dev/tty ||
		error "uploading public key failed"

# start ssh-agent and add private key to ssh agent
info "adding key to ssh-agent"
exec ssh-agent bash && ssh-add "${github_privkey}"

info "done!"
